---
title: "PAM_analysis"
author: "Caitlin Bergman"
date: "11/11/2021"
output: html_document
---

```{r}
#load libraries:
library(datarium)
library(rstatix)
library(ggpubr)
library(DHARMa)
library(mgcv)
library(fitdistrplus)
library(goft)
library(gamlss)
library(car)
library(performance)
library(LambertW)
library(tidyverse)
pam<-read_delim("Aggregating_PAM_measurements.csv", delim = ",")
base <- read_delim("base_measurements.csv", delim = ",")
food <- read_delim("Aggregating_Feeding.csv", delim = ",")
```

```{r}
#Clean data
pam_clean <- pam %>%
  filter(Measurement != "NA") 
base_clean<-base%>%
  filter(Treatment != "NA")%>%
  na.omit(Average_Diameter)


pam_clean$Anemone_ID <- as.factor(pam_clean$Anemone_ID)
pam_clean$Bucket <- as.factor(pam_clean$Bucket)
food$Feeding_Time_Min <- as.numeric(food$Feeding_Time_Min)
  as.character(base_clean$Date)
  base_clean$Date <- factor(base_clean$Date, levels =c("Oct 31", "Nov 5", "Nov 9", "Nov 13"))

```
# PAM data

```{r}
#Line graph of PAM (morning vs afternoon during heatwave)
standard_error <- function(x) sd(x) / sqrt(length(x)) 

pam_summary <- pam_clean%>%
  group_by(Measurement, Treatment) %>%
  summarize(mean_FvFm = mean(Fv_Fm_av), se_FvFm = standard_error(Fv_Fm_av))

ggplot(data = pam_summary, aes(x=Measurement, y = mean_FvFm, group = Treatment, colour = Treatment)) +
       geom_vline(xintercept=c("T2", "T7"), linetype = "dotted") +
        theme_classic() +
         geom_point() +
        geom_line() +
        geom_errorbar(aes(ymin = mean_FvFm - se_FvFm, ymax = mean_FvFm + se_FvFm), width=0.2)
ggsave("pam_timeseries.png")
```
```{r}
pam_heatwave<-pam_clean%>%
  filter(Date == "11/6/2021" |  Date == "11/8/2021")
pam_heatwave$Time <- factor(pam_heatwave$Time, levels = c("Morning", "Afternoon"))
ggplot(pam_heatwave, aes(fill=Treatment, y=Fv_Fm_av, x=Time)) + 
  geom_boxplot() +
  facet_grid(. ~ Date)
ggsave("pam_MorningAfternoon.png")
```


```{r}
#Checking assumptions of PAM data
#Outliers
pam_clean %>%
  group_by(Measurement, Treatment) %>%
  identify_outliers(Fv_Fm_av)
# 15 outliers, and 4 extreme outliers

#Normality
pam_clean %>%
  group_by(Measurement, Treatment) %>%
  shapiro_test(Fv_Fm_av)
#10 time/treatment combinations that are not normally distributed  (P<0.05)

#qqplot
ggqqplot(pam_clean, "Fv_Fm_av", ggtheme = theme_bw()) +
  facet_grid(Measurement ~ Treatment, labeller = "label_both")

#Conclusion: Data does not meet assumptions of ANOVA. Try other distributions.
```


```{r}
#Testing new distribution for PAM data

fitDist(Fv_Fm_av, data = pam_clean, type = "real0to1", try.gamlss = T)

#Generalized Beta 1 distribution found to be the best fit

histDist(pam_clean$Fv_Fm_av, "GB1", density = F, main = "GB1")
```
```{r}
#Trying a gamlss model on PAM data (T1, T2, T8, and T9), using Gumbel distribution:
pam_timeseries <- pam_clean %>% 
  select(Fv_Fm_av, Treatment, Measurement, Anemone_ID, Event) %>%
  filter(Measurement == "T1" | Measurement  == "T2" | Measurement == "T8" | Measurement == "T9")%>%
  mutate(Treatment = as.factor(Treatment), 
         Treatment = fct_relevel(Treatment, "Control", "25C", "30C"),
         Event = as.factor(Event),
         Measurement = as.factor(Measurement))

fitDist(Fv_Fm_av, data = pam_timeseries, type = "realAll", try.gamlss = T)

histDist(pam_timeseries$Fv_Fm_av, "GU", density = F, main = "Gumbel")
pam_mod <- gamlss(Fv_Fm_av ~ Treatment*Measurement + random(Anemone_ID), data = pam_timeseries, family = GU())


summary(pam_mod)
```

```{r}
#Trying a gamlss model on PAM data (T2, T3, T6, T7), using GB1 distribution:
pam_timeseries2 <- pam_clean %>% 
  select(Fv_Fm_av, Treatment, Measurement, Anemone_ID, Event) %>%
  filter(Measurement == "T2" | Measurement  == "T3" | Measurement == "T6" | Measurement == "T7")%>%
  mutate(Treatment = as.factor(Treatment), 
         Treatment = fct_relevel(Treatment, "Control", "25C", "30C"),
         Event = as.factor(Event),
         Measurement = as.factor(Measurement))

fitDist(Fv_Fm_av, data = pam_timeseries2, type = "realAll", try.gamlss = T)

#Best fit:generalized Gamma Lopatatsidis-Green (GG)

histDist(pam_timeseries$Fv_Fm_av, "GG", density = F, main = "generalised Gamma Lopatatsidis-Green")
pam_mod <- gamlss(Fv_Fm_av ~ Treatment*Measurement, data = pam_timeseries2, family = GG(), control = gamlss.control(n.cyc = 200))


summary(pam_mod)
```



```{r}
#Kruskal-Wallis for each day: 
pam_nov1 <- pam_clean %>%
filter(Measurement == "T1")
kruskal.test(Fv_Fm_av ~ Treatment, data = pam_nov1)

pam_nov6am <- pam_clean %>%
filter(Measurement == "T2")
kruskal.test(Fv_Fm_av ~ Treatment, data = pam_nov6am)

pam_nov6pm <- pam_clean %>%
filter(Measurement == "T3")
kruskal.test(Fv_Fm_av ~ Treatment, data = pam_nov6pm)

pam_nov7pm <- pam_clean %>%
filter(Measurement == "T5")
kruskal.test(Fv_Fm_av ~ Treatment, data = pam_nov7pm)

pam_nov8am <- pam_clean %>%
filter(Measurement == "T6")
kruskal.test(Fv_Fm_av ~ Treatment, data = pam_nov8am)

pam_nov8pm <- pam_clean %>%
filter(Measurement == "T7")
kruskal.test(Fv_Fm_av ~ Treatment, data = pam_nov8pm)

pam_nov9 <- pam_clean %>%
filter(Measurement == "T8")
kruskal.test(Fv_Fm_av ~ Treatment, data = pam_nov9)

pam_nov13 <- pam_clean %>%
filter(Measurement == "T9")
kruskal.test(Fv_Fm_av ~ Treatment, data = pam_nov13)


```


# Base measurements

```{r}
base_summary <- base_clean%>%
  group_by(Date, Treatment)%>%
  summarize(mean_base = mean(Average_Diameter), se_base = standard_error(Average_Diameter))

ggplot(base_clean, aes(fill = Treatment, x=Date, y = Average_Diameter)) + 
        theme_classic() +
         geom_boxplot() 

```
```{r}
#Testing distribution for base data:

fitDist(Average_Diameter, data = base_clean, type = "realplus", try.gamlss = T)

#LNO (box-cox) found to be the best fit

histDist(base_clean$Average_Diameter, "LNO", density = F, main = "LNO")
```

# Feeding time

```{r}
food_summary <- food%>%
  group_by(Date, Treatment)%>%
  summarize(mean_time = mean(Feeding_Time_Min), se_time = standard_error(Feeding_Time_Min))
ggplot(data = food_summary, aes(x=Date, y = mean_time, group = Treatment, colour = Treatment)) + 
        theme_classic() +
         geom_point() +
        geom_line() +
        geom_errorbar(aes(ymin = mean_time- se_time, ymax = mean_time + se_time), width=0.2)

ggplot(food, aes(fill = Treatment, x=Date, y = Feeding_Time_Min)) + 
        theme_classic() +
         geom_boxplot() 
      

```
```{r}
#Testing distribution for base data:


fitDist(Feeding_Time_Min, data = food, type = "realplus", try.gamlss = T)

#LNO (box-cox) found to be the best fit

histDist(food$Feeding_Time_Min, "LNO", density = F, main = "LNO")
```

