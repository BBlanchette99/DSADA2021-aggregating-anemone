---
title: "PAM_analysis"
author: "Caitlin Bergman"
date: "11/11/2021"
output: html_document
---
Loading libraries and data
```{r}
library(rstatix) #Used for anova_test function
library(DHARMa)
library(fitdistrplus)#Used to fit distributions to data
library(goft)
library(patchwork)#for making pretty figures
library(ordinal)#For ordinal regression
library(performance)
library(scales)
library(gamlss) # For gamlss models
library(brms) #for baysian model
library(LambertW) #for Gaussianize function
library(tidyverse)

#Loading data
pam<-read_delim("data/pam_data.csv", delim = ",")
base <- read_delim("data/base_diameter_data.csv", delim = ",")
food <- read_delim("data/feeding_time_data.csv", delim = ",")
open_closed <- read_delim("data/open_closed_data.csv", delim = ",")
hemocytometer <- read_delim("data/hemocytometer_data_clean.csv", delim = ",")
```

# Cleaning data

```{r}
#Creating a clean dataframe for each response variable, and a summarized dataframe with average value for each treatment at each measurement time

#Function to calculate standard error for data summaries
standard_error <- function(x) sd(x) / sqrt(length(x))

#cleaning PAM data
pam_clean <- pam %>%
  filter(Measurement != "NA")%>% #Removing dates with PAM measurements that we are not using due to technical errors
  select(Date,Time,Measurement,Treatment,Bin,Site,Anemone_ID,Fv_Fm_av)%>%
  mutate(Date = as.POSIXct(as.character(Date),
                           format="%m/%d/%Y %H:%M:%S"),
         Anemone_ID = as.factor(Anemone_ID), 
         Bin = as.factor(Bin), 
         Measurement = as.factor(Measurement), 
         Site = as.factor(Site), 
         Time = factor(Time, levels = c("Pre-heat", "Post-heat")),
         Treatment = fct_relevel(as.factor(Treatment), "Control", "25C", "30C"))

pam_summary <- pam_clean%>%
  group_by(Date, Measurement, Treatment) %>%
  summarize(mean_FvFm = mean(Fv_Fm_av), se_FvFm = standard_error(Fv_Fm_av))

#Cleaning base data
base_clean<-base%>%
  filter(Treatment != "NA", Average_Diameter != "NA")%>%
   droplevels()%>%
  mutate(Date = factor(Date, levels =c("31-Oct", "05-Nov", "09-Nov", "13-Nov")), Event = fct_relevel(as.factor(Event), "Initial","Before heatwave", "After heatwave", "Recovery"),Treatment = fct_relevel(as.factor(Treatment), "Control", "25C", "30C"), Anemone_ID = as.factor(Anemone_ID), Bin = as.factor(Bin), Site = as.factor(Site)) %>%
select(Date,Event,Treatment,Bin,Site,Anemone_ID,Average_Diameter)%>%
   arrange_all()

base_summary <- base_clean%>%
  group_by(Date, Treatment)%>%
  summarize(mean_base = mean(Average_Diameter), se_base = standard_error(Average_Diameter))

#Cleaning feeding time data
food_clean <- food%>%
  filter(Date != "10/28/2021")%>%
  mutate(Feeding_Time_Min = as.numeric(Feeding_Time_Min),Event = fct_relevel(as.factor(Event),"Initial", "Before heatwave", "After heatwave", "Recovery"),Date = as.factor(Date), Site = as.factor(Site), Treatment = fct_relevel(as.factor(Treatment), "Control", "25C", "30C"), Anemone_ID = as.factor(Anemone_ID), Bin = as.factor(Bin))%>%
select(Date, Event,Treatment, Bin, Site, Anemone_ID, Feeding_Time_Min)%>%
  arrange_all()


food_summary <- food%>%
  group_by(Date, Treatment)%>%
  summarize(mean_time = mean(Feeding_Time_Min), se_time = standard_error(Feeding_Time_Min))

#Cleaning open/closed response data
open_closed_clean <- open_closed %>%
  mutate(Date = as.factor(Date),Anemone_ID = as.factor(Anemone_ID),Time_Block = fct_relevel(as.factor(Time_Block), "0", "1", "2", "3", "4", "5", "6"), Treatment = as.factor(Treatment),  Open_Closed = as.factor(Open_Closed), Open_Closed = factor(Open_Closed, levels = c("Open", "Partially open", "Closed"), ordered = TRUE), Treatment = fct_relevel(Treatment, "Control", "25C", "30C"))%>%
  dplyr::select(Date, Time_Block,Bin, Treatment, Open_Closed, Anemone_ID)

open_closed_summary <- open_closed_clean %>%
group_by(Date, Treatment, Time_Block)%>%
  count(Open_Closed)
  
#Cleaning hemocytometer data
hemo_clean <- hemocytometer %>%
  mutate(Tentacle_Mass_mg = (Tentacle_Mass_g*1000), Dino_Density = ((Number_Dino_Average*0.5)/(Tentacle_Mass_mg*0.0001)), Green_Density = ((Number_Green_Average*0.5)/(Tentacle_Mass_mg*0.0001)), Dino_MI = (Dividing_Dino_Average/Number_Dino_Average)) %>%
  mutate(Date = as.factor(Date), Treatment = as.factor(Treatment), Bin = as.factor(Bin), Site = as.factor(Site), Anemone_ID = as.factor(Anemone_ID)) %>%
mutate(Date = as.POSIXct(as.character(Date),   format="%m/%d/%Y"))%>%
  select(Date, Treatment, Bin, Site, Anemone_ID, Tentacle_Mass_mg, Number_Dino_Average, Number_Green_Average, Dividing_Dino_Average, Dividing_Green_Average, Dino_Density, Green_Density, Dino_MI) %>%
  group_by(Date, Treatment)

hemo_summary <- hemo_clean%>%
  group_by(Date, Treatment) %>%
  summarize(mean_Dino_Density = mean(Dino_Density), se_Dino_Density = standard_error(Dino_Density), mean_Green_Density = mean(Green_Density), se_Green_Density = standard_error(Green_Density), mean_Dino_MI = mean(Dino_MI), se_Dino_MI = standard_error(Dino_MI))
```

# PAM data analysis

## Plots
Plotting a timeseries of all PAM data
```{r}
ggplot(data = pam_summary, 
       aes(x=Date, 
           y = mean_FvFm, 
           group = Treatment, 
           colour = Treatment)) +
  theme_classic() +
  geom_vline(xintercept = as.POSIXct("2021-11-06 09:00:00"),
             linetype = "dotted", 
             size = 1) +
  geom_vline(xintercept = as.POSIXct("2021-11-08 16:00:00"), 
             linetype = "dotted", 
             size = 1)+
  geom_point(size=2.5) +
  geom_line(lwd = 1.5) +
  geom_errorbar(aes(ymin = mean_FvFm - se_FvFm, 
                    ymax = mean_FvFm + se_FvFm), 
                    width=30000)+
  labs(x="Date", 
       y = "Photosynthetic efficiency (Fv/Fm)") +
  scale_fill_manual(values = c('#89226AFF',
                              '#2C728EFF',    
                              '#E65154FF')) +
  scale_colour_manual(values = c('#89226AFF',
                                 '#2C728EFF',
                                 '#E65154FF'))+
  theme(axis.text=element_text(size=15),
        axis.title=element_text(size=20), 
        legend.text=element_text(size=15), 
        legend.title=element_text(size=20))

ggsave(path = "plots",filename = "pam_overall_line.png", width = 10, height = 7)
```

Plotting a timeseries of all morning PAM measurements (5 timepoints)
```{r}
p1_data <- pam_summary%>%
  filter(Measurement == "T1"| Measurement == "T2"| Measurement == "T6" | Measurement == "T8"| Measurement =="T9")

ggplot(data = p1_data,
       aes(x=Date, 
           y = mean_FvFm, 
           group = Treatment, 
           colour = Treatment)) +
  theme_classic() +
  geom_vline(xintercept = as.POSIXct("2021-11-06 09:00:00"),
             linetype = "dotted", 
             size = 1) +
  geom_vline(xintercept = as.POSIXct("2021-11-08 16:00:00"), 
             linetype = "dotted", 
             size = 1)+
  geom_point(size=3) +
  geom_line(lwd = 2) +
 scale_x_datetime(breaks=date_breaks("3 days"),labels=date_format("%b-%d"))+
  geom_errorbar(aes(ymin = mean_FvFm - se_FvFm, 
                    ymax = mean_FvFm + se_FvFm), 
                    width=30000)+
  labs(x="Date", 
       y = "Photosynthetic efficiency (Fv/Fm)") +
  scale_fill_manual(values = c('#89226AFF', '#2C728EFF','#E65154FF'))+
  scale_colour_manual(values = c('#89226AFF', '#2C728EFF','#E65154FF'))+
  theme(axis.text=element_text(size=15),
        axis.title=element_text(size=20), 
        legend.text=element_text(size=15), 
        legend.title=element_text(size=20))

ggsave(path = "plots",filename = "pam_timeseries.jpg", width = 15, height = 7)
```

# Check with Beth, then delete this graph:
```{R}
#Graph of PAM data during heatwave, with heatwave time periods marked
ggplot(data = filter(pam_summary, 
                     Measurement != "T1" & Measurement != "T8" & Measurement != "T9"), 
                     aes(x=Date, 
                         y = mean_FvFm, 
                         group = Treatment, 
                         colour = Treatment)) +
theme_classic() +
geom_rect(xmin=as.POSIXct("2021-11-06 9:00:00"), 
          xmax=as.POSIXct("2021-11-06 15:00:00"), 
          ymin = 0.40, 
          ymax = 0.60, 
          fill = "grey84",
          colour = "grey84")+
geom_rect(xmin=as.POSIXct("2021-11-07 9:00:00"), 
          xmax=as.POSIXct("2021-11-07 15:00:00"), 
          ymin = 0.40, 
          ymax = 0.60, 
          fill = "grey84", 
          colour = "grey84")+
geom_rect(xmin=as.POSIXct("2021-11-08 9:00:00"), 
          xmax=as.POSIXct("2021-11-08 15:00:00"), 
          ymin = 0.40, 
          ymax = 0.60,
          fill = "grey84",
          colour = "grey84")+
geom_point() +
geom_line() +
geom_errorbar(aes(ymin = mean_FvFm - se_FvFm, 
                  ymax = mean_FvFm + se_FvFm), 
              width=10000)+
labs(x="Date", 
     y = "Photosynthetic efficiency (Fv/Fm)") +
scale_fill_manual(values = c('#89226AFF',
                             '#2C728EFF',           
                             '#E65154FF')) +
scale_colour_manual(values = c('#89226AFF', 
                               '#2C728EFF', 
                              '#E65154FF'))+
  theme(axis.text=element_text(size=30),
        axis.title=element_text(size=35), 
        legend.text=element_text(size=30), 
        legend.title=element_text(size=35))
ggsave(path = "plots",filename = "pam_heatwave_line.png", width = 10, height = 7)
```


Plot comparing morning and afternoon PAM measurements on first and third days of heatwave:
```{R}
pam_heatwave<-pam_clean%>%
  filter(Measurement == "T2" | 
        Measurement == "T3" | 
        Measurement == "T6" | 
        Measurement == "T7") %>%
  separate(Date, c('Day', 'Hour'), sep = " ", remove = T)%>%
 mutate(Day = fct_relevel(Day, "2021-11-06", "2021-11-08"))

  levels(pam_heatwave$Day) <- c("Heatwave day 1", "Heatwave day 3")


ggplot(pam_heatwave, aes(fill=Treatment, y=Fv_Fm_av, x=Time)) + 
  geom_boxplot() +
 scale_fill_manual(values = c('#89226AFF','#2C728EFF','#E65154FF')) +
   labs(x = "Measurement time", y = "Photosynthetic efficiency (Fv/Fm)")+
  facet_grid(.~Day) +
  theme_classic() +
  theme(strip.text.x = element_text(size = 15),
       axis.text=element_text(size=15),
        axis.title=element_text(size=20), 
        legend.text=element_text(size=15), 
        legend.title=element_text(size=20))
        
ggsave(path = "plots",filename = "pam_heatwave_boxplot.png", width = 15, height = 7)
```

## Testing distributions
```{r}
#Checking assumptions of PAM data
#Outliers
pam_clean %>%
  group_by(Measurement, Treatment) %>%
  identify_outliers(Fv_Fm_av)
#Test shows 15 outliers, and 4 extreme outliers

#Normality
pam_clean %>%
  group_by(Measurement, Treatment) %>%
  shapiro_test(Fv_Fm_av)
#10 time/treatment combinations that are not normally distributed  (P<0.05)

#Conclusion: Data does not meet assumptions of ANOVA. 

#Transformations (acrsin and log)
pam_clean <- pam_clean %>%
  mutate(arcsin_Fv_Fm = asin(sqrt(Fv_Fm_av)), log_Fv_Fm = log(Fv_Fm_av))

shapiro.test(pam_clean$arcsin_Fv_Fm)
shapiro.test(pam_clean$log_Fv_Fm)

#P-values for all transformations are less than 0.05. Data are still not normally distributed after transformation. 
```

```{r}
#Testing new distribution for PAM data

fitDist(Fv_Fm_av, data = pam_clean, type = "real0to1", try.gamlss = T)

#Generalized Beta 1 distribution is best fit

histDist(pam_clean$Fv_Fm_av, "GB1", density = F, main = "GB1")
```


## Gamlss model

```{r}
#Gamlss model for morning measurement PAM data (T1, T2, T6, T8, and T9) using Gumbel distribution:

pam_long_timeseries <- pam_clean %>% 
  filter(Measurement == "T1" | Measurement  == "T2" |Measurement == "T6"| Measurement == "T8" | Measurement == "T9")%>%
  mutate(Measurement = fct_relevel(Measurement, "T1", "T2", "T6", "T8", "T9"))%>%
  arrange_all()

shapiro_test(pam_long_timeseries$transformed_Fv_Fm)
bartlett.test(transformed_Fv_Fm ~ Treatment, data = pam_long_timeseries)
         

fitDist(Fv_Fm_av, data = pam_long_timeseries, type = "realAll", try.gamlss = T)
#Outcome: Gumbel is the best fit

histDist(pam_long_timeseries$Fv_Fm_av, "GU", density = F, main = "Gumbel")

#Full model
pam_full_mod <- gamlss(Fv_Fm_av ~ Treatment + Measurement + Treatment*Measurement + random(Anemone_ID) + random(Site) + random(Bin), data = pam_long_timeseries, family = GU(), control = gamlss.control(n.cyc=200))

#Backwards model selection to find best model:
pam_mod <- stepGAIC(pam_full_mod, direction = "backward", trace = F)

formula(pam_mod)
#Final model includes treatment, measurement, treatment * measurement, and random(Anemone_ID)

summary(pam_mod)
```

```{r}
#Trying a gamlss model on PAM data (T2, T3, T6, T7), using GB1 distribution:
pam_short_timeseries <- pam_clean %>% 
  filter(Measurement == "T2" | Measurement  == "T3" |  Measurement == "T6" | Measurement == "T7")%>%
  mutate(Measurement = fct_relevel(Measurement, "T2", "T3", "T6", "T7"), Date = as.factor(Date),)%>%
select(Date, Measurement, Treatment, Anemone_ID, Fv_Fm_av, Bin, Site)%>%
     arrange_all()

fitDist(Fv_Fm_av, data = pam_short_timeseries, type = "realAll", try.gamlss = T)
#Best fit: generalized beta type 1


histDist(pam_short_timeseries$Fv_Fm_av, "GG", density = F, main = "generalised Gamma Lopatatsidis-Green")

pam_mod_full2 <- gamlss(Fv_Fm_av ~ Treatment + Measurement + Treatment*Measurement + random(as.factor(Bin)) + random(as.factor(Site)), data = pam_short_timeseries, family = GG(), control = gamlss.control(n.cyc=200))


pam_mod_2 <- stepGAIC(pam_mod_full2, direction = "backward")
formula(pam_mod_2)
summary(pam_mod_2)


```


## Friedman test
```{r}
#Friedman tests on morning PAM measurements
# On control
pam_control <- pam_long_timeseries%>%
  filter(Treatment == "Control")%>%
  droplevels()

pam_control %>%
   friedman_test(Fv_Fm_av ~ Measurement |Anemone_ID)
#Significant results! Use Wilcox test:
pam_control%>%
wilcox_test(Fv_Fm_av ~ Measurement, paired = TRUE, p.adjust.method = "bonferroni")

#on 25C
pam_25 <- pam_long_timeseries%>%
  filter(Treatment == "25C")%>%
  droplevels()

pam_25 %>%
   friedman_test(Fv_Fm_av ~ Measurement |Anemone_ID)
#Significant results! Use Wilcox test:
pam_25%>%
wilcox_test(Fv_Fm_av ~ Measurement, paired = TRUE, p.adjust.method = "bonferroni")

#on 30
pam_30 <- pam_long_timeseries%>%
  filter(Treatment == "30C")%>%
  droplevels()

pam_30 %>%
   friedman_test(Fv_Fm_av ~ Measurement |Anemone_ID)
#Significant results! Use Wilcox test:
pam_30%>%
wilcox_test(Fv_Fm_av ~ Measurement, paired = TRUE, p.adjust.method = "bonferroni")
```
```{r}
#Friedman tests on heatwave PAM measurements
# On control
pam_control <- pam_short_timeseries%>%
  filter(Treatment == "Control")%>%
  droplevels()

 pam_control %>%
   friedman_test(Fv_Fm_av ~ Measurement |Anemone_ID)
 #Significant results! Use Wilcox test:

pam_control%>%
wilcox_test(Fv_Fm_av ~ Measurement, paired = TRUE, p.adjust.method = "bonferroni")

#on 25C
pam_25 <- pam_short_timeseries%>%
  filter(Treatment == "25C")%>%
  droplevels()

pam_25 %>%
   friedman_test(Fv_Fm_av ~ Measurement |Anemone_ID)
#Significant results! Use Wilcox test:
pam_25%>%
wilcox_test(Fv_Fm_av ~ Measurement, paired = TRUE, p.adjust.method = "bonferroni")


#on 30
pam_30 <- pam_short_timeseries%>%
  filter(Treatment == "30C")%>%
  droplevels()

pam_30 %>%
   friedman_test(Fv_Fm_av ~ Measurement |Anemone_ID)
#Significant results! Use Wilcox test:

pam_30%>%
wilcox_test(Fv_Fm_av ~ Measurement, paired = TRUE, p.adjust.method = "bonferroni")
```
## Kruskall Wallis tests
```{r}
#KW test on morning pam measurements at each time point
#Nov 1 measurement:
  kruskal.test(Fv_Fm_av~Treatment, data = filter( pam_long_timeseries, Measurement == "T1"))
#No significant results

#Nov 6 measurement:
  kruskal.test(Fv_Fm_av~Treatment, data = filter( pam_long_timeseries, Measurement == "T2"))
#Significant results! Use Dunn test:
  dunn_test(Fv_Fm_av~Treatment, data = filter( pam_long_timeseries, Measurement == "T2"))

#Nov 8 measurement:
  kruskal.test(Fv_Fm_av~Treatment, data = filter( pam_long_timeseries, Measurement == "T6"))
#No significant results

#Nov 9 measurement:
  kruskal.test(Fv_Fm_av~Treatment, data = filter( pam_long_timeseries, Measurement == "T8"))
#No significant results
  
#Nov 13 measurement:
  kruskal.test(Fv_Fm_av~Treatment, data = filter( pam_long_timeseries, Measurement == "T9"))
#No significant results
```


```{r}
#KW test on heatwave PAM measurements. Only afternoon measurements are analyzed, because morning timepoints were analyzed in the previous section.

#Nov 6 post-heat measurement:
  kruskal.test(Fv_Fm_av~Treatment, data = filter( pam_short_timeseries, Measurement == "T3"))
#Significant results! Use Dunn test:
dunn_test(Fv_Fm_av~Treatment, data = filter( pam_short_timeseries, Measurement == "T3"))

#Nov 8 post-heat measurement:
  kruskal.test(Fv_Fm_av~Treatment, data = filter( pam_short_timeseries, Measurement == "T7"))
#Significant results! Use Dunn test:
  dunn_test(Fv_Fm_av~Treatment, data = filter( pam_short_timeseries, Measurement == "T7"))
```

# Base measurements

```{r}
summary(base_clean)
```

## Plots

```{r}
ggplot(base_clean, aes(fill = Treatment, x=Event, y = Average_Diameter)) + 
        theme_classic() +
         geom_boxplot() +
labs(x = "Measurement time", y = "Base diameter (mm)") +
  scale_fill_manual(values = c('#89226AFF',
                              '#2C728EFF',    
                              '#E65154FF')) +
  theme(axis.text=element_text(size=15),
        axis.title=element_text(size=20), 
        legend.text=element_text(size=15), 
        legend.title=element_text(size=20))
ggsave(path = "plots",filename = "base_boxplot.png", width = 10, height = 7)
```

## Testing distributions

```{r}
shapiro_test(base_clean$Average_Diameter)
#Data is non-normal

base_clean <- base_clean %>%
  mutate(log_diameter = log(Average_Diameter))
shapiro_test(base_clean$log_diameter)
#Log transformed data is normal

bartlett.test(log_diameter ~ Treatment, data = base_clean)
#Log transformed data has equal variances

base_clean %>%
  group_by(Date, Treatment) %>%
  identify_outliers(log_diameter)
#One extreme outlier
```

## ANOVA tests - delete later if not using

```{r}
base_aov <- aov(log_diameter ~ Treatment*Date + random(Anemone_ID), data=base_clean)
summary(base_aov)
TukeyHSD(base_aov)


Dino_Density_aov <- aov(log_Dino_Density ~ Treatment*Date, data=hemo_clean)
summary(Dino_Density_aov)
TukeyHSD(Dino_Density_aov)
```

## Gamlss model

```{r}

fitDist(Average_Diameter, data = base_clean, type = "realAll", try.gamlss = T)
#Best fit: Box-Cox (LNO)

histDist(base_clean$Average_Diameter, "LNO", density = F, main = "Box-Cox")

base_mod_1 <- gamlss(Average_Diameter ~ Treatment*Date, data = base_clean, family = LNO())

base_mod_2 <- gamlss(log_diameter ~ Treatment*Date + random(Anemone_ID), data = base_clean, family = NO())

AIC(base_mod_1, base_mod_2)
#base_mod_2 (using the log-transformed data) has a lower AIC and therefore is a better fit for the data. 

summary(base_mod_2)
```

## Friedman tests
```{r}
#Friedman tests comparing each treatment over all timepoints
# On control
base_control <- base_clean%>%
  filter(Treatment == "Control")%>%
  droplevels()

table(base_control$Date, base_control$Anemone_ID)

base_control %>%
   friedman_test(Average_Diameter ~ Date |Anemone_ID)
#No significant results

#on 25C
base_25 <-base_clean%>%
  filter(Treatment == "25C")%>%
  droplevels()

base_25 %>%
   friedman_test(Average_Diameter ~ Date |Anemone_ID)
#No significant results

#on 30
base_30 <- base_clean%>%
  filter(Treatment == "30C")%>%
  droplevels()

base_30 %>%
   friedman_test(Average_Diameter ~ Date |Anemone_ID)
#No significant results
```
## Kruskal-Wallis tests
```{r}
#KW test on all treatments at each of the four timepoints
#Oct. 31 measurements:
  kruskal.test(Average_Diameter~Treatment, data = filter( base_clean, Date == "31-Oct"))
#No significant results

#Nov 5 measurements
kruskal.test(Average_Diameter~Treatment, data = filter( base_clean, Date == "05-Nov"))
#No significant results

#Nov 9 measurements
kruskal.test(Average_Diameter~Treatment, data = filter( base_clean, Date == "09-Nov"))
#No significant results

#Nov 9 measurements
kruskal.test(Average_Diameter~Treatment, data = filter( base_clean, Date == "13-Nov"))
#No significant results
```



# Feeding time

## Plots

```{r}
#Line graph of feeding time
ggplot(data = food_summary, aes(x=Date, y = mean_time, group = Treatment, colour = Treatment)) + 
        theme_classic() +
         geom_point() +
        geom_line() +
        geom_errorbar(aes(ymin = mean_time- se_time, ymax = mean_time + se_time), width=0.2)

#Boxplot of feeding time
ggplot(food_clean, aes(fill = Treatment, x=Event, y = Feeding_Time_Min)) + 
        theme_classic() +
         geom_boxplot() +
  labs(x = "Measurement time", y = "Feeding time (min)") +
  scale_fill_manual(values = c('#89226AFF',
                              '#2C728EFF',    
                              '#E65154FF')) +
  theme(axis.text=element_text(size=15),
        axis.title=element_text(size=20), 
        legend.text=element_text(size=15), 
        legend.title=element_text(size=20))
ggsave(path = "plots",filename = "food_boxplot.png", width = 10, height = 7)
```

## Testing assumption

```{r}
shapiro.test(food_clean$Feeding_Time_Min)
#Data is non-normal

food_clean<-food_clean%>%
shapiro_test(food_clean$log_Feeding_Time_Min)
#Log transformed data fits normal distribution

bartlett.test(log_Feeding_Time_Min ~ Treatment, data = food_clean)
#Log transformed data has equal variances

food_clean %>%
  group_by(Date, Treatment) %>%
  identify_outliers(log_Feeding_Time_Min)
#Log transformed data has no extreme outliers
```

## ANOVA - delete if not using

```{r}
food_aov <- aov(log_Feeding_Time_Min ~ Treatment*Date + random(Anemone_ID), data=food_clean)
summary(food_aov)
TukeyHSD(food_aov)


test <- gamlss(log_Feeding_Time_Min ~ Treatment*Date + random(Anemone_ID),  data = food_clean)
summary(test)
```


## Gamlss models
```{r}
fitDist(Feeding_Time_Min, data = food_clean, type = "realAll", try.gamlss = T)
#Best fit: Box-Cox (LNO)

histDist(food_clean$Feeding_Time_Min, "LNO", density = F, main = "Box-Cox")

food_mod_1 <- gamlss(Feeding_Time_Min ~ Treatment*Date + random(Anemone_ID), data = food_clean, family = LNO())

#Use log transformation because no errors and better AIC
food_mod_2 <- gamlss(log_Feeding_Time_Min ~ Treatment*Date + random(Anemone_ID), data = food_clean, family = NO())

GAIC(food_mod_1, food_mod_2)
#food_mod_2 (using log-transformed data) has lower AIC and is therefore a better fit for the data.

summary(food_mod_2)

```

## Friedman tests
```{r}
#Friedman tests comparing each treatment over all timepoints
# On control
food_control <- food_clean%>%
  filter(Treatment == "Control")%>%
  droplevels()

food_control %>%
   friedman_test(Feeding_Time_Min ~ Date |Anemone_ID)
#Significant results - perform Wilcox test

food_control%>%
wilcox_test(Feeding_Time_Min ~ Date, paired = TRUE, p.adjust.method = "bonferroni")
#No combinations have significant results

#on 25C
food_25 <-food_clean%>%
  filter(Treatment == "25C")%>%
  droplevels()

food_25 %>%
   friedman_test(Feeding_Time_Min ~ Date |Anemone_ID)
#No significant results

#on 30
food_30 <- food_clean%>%
  filter(Treatment == "30C")%>%
  droplevels()

food_30 %>%
   friedman_test(Feeding_Time_Min ~ Date |Anemone_ID)
#No significant results
```
## KW tests
```{R}
#KW test on all treatments at each of the four timepoints
#Oct. 31 measurements:
  kruskal.test(Feeding_Time_Min~Treatment, data = filter( food_clean, Date == "11/01/2021"))
#No significant results

#Nov 5 measurements
kruskal.test(Feeding_Time_Min~Treatment, data = filter( food_clean, Date == "11/05/2021"))
#No significant results

#Nov 9 measurements
kruskal.test(Feeding_Time_Min~Treatment, data = filter(food_clean, Date == "11/09/2021"))
#No significant results

#Nov 9 measurements
kruskal.test(Feeding_Time_Min~Treatment, data = filter(food_clean, Date == "11/13/2021"))
#No significant results
```


# Open/closed measurements

## Plots

```{r}
ggplot(data = open_closed_summary, aes(x = Time_Block, y = n, fill = Open_Closed)) + 
  geom_bar(position = "fill", stat = "identity") + 
  facet_grid(Date ~ Treatment) +
  labs(x="Time (hours)", y = "Proportion", fill = "Behaviour") +
  theme_classic()+
scale_fill_manual(values = c('#FFE082',
                              '#2C728EFF',    
                              '#E65154FF'))+
  theme(strip.text.x = element_text(size = 15),
       axis.text=element_text(size=15),
        axis.title=element_text(size=20), 
        legend.text=element_text(size=15), 
        legend.title=element_text(size=20))
ggsave(path = "plots",filename = "open_closed_plot.png", width = 10, height = 7)
```

## Exploratory data analysis

```{r}
#Summarizing the data
summary(open_closed_summary)
#Making frequency table
table(open_closed_clean$Treatment, open_closed_clean$Open_Closed)

```


## Giant Green Ordinal Model - don't work, delete later

```{r}
gg_model = clmm(Open_Closed ~ Treatment:Time_Block + (1|Anemone_ID), data = open_closed_clean)
summary(gg_model)


ord_model = clmm(Open_Closed ~ Treatment:Time_Block:Date + (1|Anemone_ID), data = open_closed_clean)
summary(ord_model)

fitDist(Open_Closed, data = open_closed_clean, type = "realAll", try.gamlss = T)

```

## Bayesian model
```{r}
#options(mc.cores=parallel::detectCores())
#Weakly flat priors

bay_mod <- brm(Open_Closed ~ Treatment + Time_Block + Date + Treatment*Time_Block*Date + (1|Anemone_ID), data = open_closed_clean, family = cumulative("logit"))

summary(bay_mod)

```

# Hemocytometer Data

## Plots
```{r}
#Dinoflagellate density
p1 <- ggplot(data = hemo_summary, 
       aes(x= Date, 
           y = mean_Dino_Density, 
           group = Treatment, 
           colour = Treatment)) +
  theme_classic() +
  geom_errorbar(aes(ymin = mean_Dino_Density - se_Dino_Density, 
                    ymax = mean_Dino_Density + se_Dino_Density), 
                   width=30000) +
  geom_vline(xintercept = as.POSIXct("2021-11-06 09:00:00"),
             linetype = "dotted", 
             size = 1) +
  geom_vline(xintercept = as.POSIXct("2021-11-08 16:00:00"), 
             linetype = "dotted", 
             size = 1)+
  geom_point(size=3) +
  geom_line(lwd = 2) +
  scale_fill_manual(values =c('#89226AFF',
   '#56B4E9FF',                            '#E65154FF')) +
  scale_colour_manual(values = c('#89226AFF',
                                 '#56B4E9FF',
                                 '#E65154FF'))+
  labs(x="Date", 
       y = "Zooxanthellae density (cells/mg)")+
   scale_x_datetime(breaks=date_breaks("3 days"),labels=date_format("%b-%d")) +
  theme(legend.position = "none")


#Mitotic Index of Dinoflagellates
p2 = ggplot(data = hemo_summary, 
       aes(x= Date, 
           y = mean_Dino_MI, 
           group = Treatment, 
           colour = Treatment)) +
  theme_classic() +
  geom_errorbar(aes(ymin = mean_Dino_MI - se_Dino_MI, 
                    ymax = mean_Dino_MI + se_Dino_MI), 
                   width=30000) +
  geom_point(size=3) +
  geom_line(lwd = 2) +
  geom_vline(xintercept = as.POSIXct("2021-11-06 09:00:00"),
             linetype = "dotted", 
             size = 1) +
  geom_vline(xintercept = as.POSIXct("2021-11-08 16:00:00"), 
             linetype = "dotted", 
             size = 1)+
   scale_fill_manual(values = c('#89226AFF',
                              '#56B4E9FF',    
                              '#E65154FF')) +
  scale_colour_manual(values = c('#89226AFF',
                                 '#56B4E9FF',
                                 '#E65154FF'))+
  labs(x="Date", 
       y = "Zooxanthellae Mitotic Index")+
   scale_x_datetime(breaks=date_breaks("3 days"),labels=date_format("%b-%d")) 

p1 + p2

ggsave(path = "plots",filename = "dinoflagellate_density_MI.png", width = 10, height = 4)
```

## Testing assumptions
```{r}
shapiro_test(hemo_clean$Dino_Density)#p=3.169^-08
shapiro_test(hemo_clean$Dino_MI) #p=0.0141

# Log transform
hemo_clean <- hemo_clean %>%
  mutate(log_Dino_Density = log(Dino_Density), log_Dino_MI = log(Dino_MI + 1), arcsine_Dino_MI = asin(sqrt(Dino_MI)), sqrt_Dino_MI = sqrt(Dino_MI))

hemo_black_box <- Gaussianize(hemo_clean$Dino_MI)

# testing transformed data
shapiro_test(hemo_clean$log_Dino_Density) #0.3057
shapiro_test(hemo_clean_MI$log_Dino_MI) #0.2152
shapiro_test(hemo_clean$arcsine_Dino_MI) #0.002478 - not normal
shapiro_test(hemo_clean$sqrt_Dino_MI) #0.00213 - not normal
shapiro_test(hemo_black_box$Dino_MI) #doesn't seem to work
#Both are normal once they've been log transformed!

bartlett.test(log_Dino_Density ~ Treatment, data = hemo_clean) #p=0.9133
bartlett.test(log_Dino_MI ~ Treatment, data = hemo_clean) #0.03211
#can assume homogeneity of variances

hemo_clean %>%
  group_by(Treatment, Date) %>%
  identify_outliers(log_Dino_Density) #Extreme outliers: A4F at 10-31 and A60B at 11-13

hemo_clean %>%
  group_by(Treatment, Date) %>%
  identify_outliers(log_Dino_MI) #Extreme outliers: A42S at 10-31, A13F at 11-13, A42S at 11-13

ungroup(hemo_clean)

```

## ANOVA
```{r}
#Dinoflagellate density
Dino_Density_aov <- aov(log_Dino_Density ~ Treatment*Date, data=hemo_clean)
summary(Dino_Density_aov)
TukeyHSD(Dino_Density_aov)
#The significant interaction that we really care about it the significant difference between 
#Might make a table to display significant values in our results section

#Dinoflagellate mitotic index
Dino_MI_aov <- aov(log_Dino_MI ~ Treatment*Date, data=hemo_clean)
summary(Dino_MI_aov)
TukeyHSD(Dino_MI_aov)
```


## Gamlss model

Likely won't use because our data fits the assumption of normality, we're going to go ahead and use an ANOVA.
```{r}
descdist(hemo_clean$Dino_MI)

#Testing new distribution for PAM data

fitDist(Dino_MI, data = hemo_clean, type = "realAll", try.gamlss = T)

#skew normal type 2 SN2 distribution is best fit

histDist(hemo_clean$Dino_MI, "SN2", density = F, main = "SN2")
```

```{r}
#Dino_MI_mod <- gamlss(Dino_MI ~ Treatment*Date, data = hemo_clean, family = SN2(), method = mixed(50, 100), control = gamlss.control(n.cyc=300))
```


